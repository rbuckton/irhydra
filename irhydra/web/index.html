<!DOCTYPE html>

<html>
  <head>
    <link rel="import" href="packages/polymer/polymer.html">
    <link rel="import" href="packages/irhydra/src/ui/hydra.html">

    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">

    <link rel="stylesheet" href='http://fonts.googleapis.com/css?family=Oswald:400,700' type='text/css'>
    <link rel="stylesheet" href='http://fonts.googleapis.com/css?family=Lato:400,700,900' type='text/css'>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=RobotoDraft:regular,bold,italic,thin,light,bolditalic,black,medium" type="text/css">

    <link rel="stylesheet" href="packages/irhydra/src/ui/ir-pane.css">
    <link rel="stylesheet" href="packages/ui_utils/assets/xref.css">
    <link rel="stylesheet" href="css/hydra.css">

    <link rel="stylesheet" href="deps/fa/css/font-awesome.min.css">

    <script src="deps/spin.min.js"></script>

    <script src="deps/esprima.js"></script>
    <script src="deps/estraverse.js"></script>
    
    <script src="renderer.js"></script>

    <script src="packages/ui_utils/assets/jquery/js/jquery-2.0.3.js"></script>
    <script src="packages/ui_utils/assets/jquery/js/jquery-ui-1.10.4.js"></script>

    <link rel="stylesheet" href="packages/ui_utils/assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="packages/ui_utils/assets/bootstrap/css/bootstrap-theme.min.css">
    <script src="packages/ui_utils/assets/bootstrap/js/bootstrap.js"></script>

    <script src="deps/bunzip2.js"></script>
  </head>

  <body>
    <div id="welcome-splash">
      <div class="welcome-message">
        <h1>IRHydra<sup>2</sup> <span id="splash-spinner"></span></h1>
        <p class="lead">This is a tool that can display intermediate representations used by V8 and Dart VM optimizing compilers.</p>
        <h2>Compilation Artifacts Cheatsheet</h2>
        <p>If you already have some artifacts collected go ahead and explore them with&nbsp;<i class="fa fa-folder-open"></i>&nbsp;otherwise here is how you can collect some.</p>
        <h3>V8</h3>
        <p class="alpha-warning">You need V8 version >= 3.24.39 to use IRHydra<sup>2</sup>. You can check <code>about:version</code> to see if your browser comes with the suitable version.</p>
        <p>You need to pass the following flags to V8 to collect IR and deoptimization artifacts and be able to use source level view:</p>
        <pre>
<span data-toggle="tooltip" data-title="Produce hydrogen.cfg containing high-level and low-level intermediate representations used by Crankshaft optimizing compiler.">--trace-hydrogen</span>
<span data-toggle="tooltip" data-title="Dump only IR from the very last phase">--trace-phase=Z</span>
<span data-toggle="tooltip" data-title="Print information about every deoptimization">--trace-deopt</span>
<span data-toggle="tooltip" data-title="Emit comments as part of generated native code. Makes deoptimization traces more informative.">--code-comments</span>
<span data-toggle="tooltip" data-title="Track precise source position information during optimization">--hydrogen-track-positions</span>
<span data-toggle="tooltip" data-title="Redirect disassembly, source dumps and deoptimizations from stdout.">--redirect-code-traces</span>
<span data-toggle="tooltip" data-title="Redirect disassembly, source dumps and deoptimizations from stdout into code.asm">--redirect-code-traces-to=code.asm</span>
</pre>
<p>Additionally you can pass the following flags to enable disassembly view. <span class="alpha-warning">This requires building V8 with <code>v8_enable_disassembler=1</code> GYP flag.</span></p>
<pre>
<span data-toggle="tooltip" data-title="Output disassembly for every generated optimized function">--print-opt-code</span>
</pre>
        <p>When run with this flags V8 will produce two files <code>hydrogen.cfg</code> and <code>code.asm</code> both of which should be loaded into IRHydra.</p>
        <p>When running in Chromium use <code>--js-flags="..."</code> to pass V8 flags and <code>--no-sandbox</code> to allow V8 to write <code>hydrogen-&lt;pid&gt;-&lt;id&gt;.cfg</code> and <code>code-&lt;pid&gt;-&lt;id&gt;.asm</code>.</p>
        <pre>
--no-sandbox                           \
--js-flags="--trace-hydrogen           \
            --trace-phase=Z            \
            --trace-deopt              \
            --code-comments            \
            --hydrogen-track-positions \
            --redirect-code-traces"
</pre>
        <p>Notice that there is no need to pass <code>--redirect-code-traces-to=code.asm</code> flag, this guarantees that in the presence of multiple renderer processes compilation artifacts are correctly split between separate files.</p>
      </div>
    </div>
    <script>
      (function () {
        $("[data-toggle=tooltip]").tooltip();

        var spinner = new Spinner({  color: '#2980B9' }).spin(document.getElementById("splash-spinner"));

        document.addEventListener("HydraReady", function () {
          spinner.stop();
        }, false);
      })();

      function DESTROY_SPLASH() {
        var splash = document.querySelector("#welcome-splash");
        if (splash) {
          splash.parentNode.removeChild(splash);
        }
      }

      // This is a helper method for loading files without
      // line-endings normalization because FileReader.readAsBinaryString
      // is not exposed to Dart.
      function readAsBinaryString(file, cb) {
        var fs = require("fs");
        fs.readFile(file.path, function(err, data) {
          cb(data.toString());
        })
      }
    </script>
    <hydra-app></hydra-app>
    <script type="application/dart">export "package:polymer/init.dart";</script>
  </body>
</html>
